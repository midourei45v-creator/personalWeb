<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Live Goods Requests</title>

<style>
:root {
  --bg: #f5f7fb;
  --card: #fff;
  --muted: #666;
  --accent: #2366d6;
}

body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: var(--bg);
  margin: 20px;
}

header {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 14px;
}

h1 {
  font-size: 1.1rem;
  margin: 0;
}

.filter-toggle {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #d0d7e6;
  background: #fff;
  cursor: pointer;
}

/* --- Collapsible filter panel --- */
.filter-panel {
  display: none;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.filter-panel.show {
  display: flex;
}

.filter-panel label {
  display: flex;
  flex-direction: column;
  font-size: 0.9rem;
  color: var(--muted);
}

select, button, input[type="search"] {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #d0d7e6;
  background: #fff;
}

/* Responsive layout for narrow screens */
@media (max-width: 720px) {
  .filter-panel {
    flex-direction: column;
    align-items: stretch;
  }
  .filter-panel label,
  .filter-panel input,
  .filter-panel select,
  .filter-panel button {
    width: 100%;
  }
}

#output {
  min-height: 80vh;
}

.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 18px;
}

.card {
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 4px 18px rgba(20, 30, 60, 0.06);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
  
.card.bought {
  opacity: 0.45;
  position: relative;
}

.card.bought::after {
  content: "‚úÖ Bought";
  position: absolute;
  top: 10px;
  right: 10px;
  background: #2ecc71;
  color: #fff;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
}
.media {
  width: 100%;
  height: 300px;
  background: #eee;
  position: relative;
  overflow: hidden;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
}

.media img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.card-body {
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.product-title {
  font-weight: 600;
  margin: 0;
  font-size: 1rem;
}

.meta-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  color: var(--muted);
  font-size: 0.9rem;
}

.meta-item {
  background: #f3f6fb;
  padding: 6px 8px;
  border-radius: 8px;
}

.footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  border-top: 1px solid #f0f2f6;
  background: #fafbfe;
  font-size: 0.85rem;
}

.hide-bought-toggle {
  font-size: 0.9em;
  margin-left: 10px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.bought {
  opacity: 0.4;
}

.timestamp {
  color: var(--muted);
}

.placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #777;
  font-size: 0.95rem;
}
</style>
</head>

<body>
<header>
  <h1>üì¶ Buy List</h1>

  <div style="display: flex; gap: 8px; align-items: center;">
    <button id="toggleFiltersBtn" class="filter-toggle">Filters ‚ñæ</button>
    <label class="hide-bought-toggle">
      <input type="checkbox" id="hideBoughtCheckbox">
      Hide Bought Items
    </label>
    <button id="AddNewItemBtn" class="filter-toggle"
      onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSct9UpDgudjiYnvmQ1UwRXLi89u8keRA1oapIjPM25-LlGmcA/viewform', '_blank')">
      Add New Item
    </button>
    
  </div>

  <div id="filterPanel" class="filter-panel">
    <label>
      Sort:
      <select id="sortSelect">
        <option value="new">Newest first</option>
        <option value="old">Oldest first</option>
        <option value="needHigh">Need (High ‚Üí Low)</option>
        <option value="needLow">Need (Low ‚Üí High)</option>
      </select>
    </label>

    <label>
      Location:
      <select id="filterLocation"><option value="">All</option></select>
    </label>

    <label>
      Shop:
      <select id="filterShop"><option value="">All</option></select>
    </label>

    <input type="search" id="searchInput" placeholder="Search product...">
    <button id="refreshBtn">üîÑ Refresh List</button>
  </div>
</header>

<main>
  <div id="output">Loading...</div>
</main>

<script>
const SHEET_ID = "1XuPRye8Rdk35hajUUqG3Ig5jFl4FmD_sDqECFK_ENBQ";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

let RAW_ROWS = [];
let REFRESH_INTERVAL_MS = 1800000; // 30 minutes
let refreshTimer = null;

function escapeHtml(str){
  if(!str && str !== 0) return "";
  return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
}

function parseImagesField(field){
  if(!field) return [];
  return field.split(/\s+/).map(link=>{
    const match = link.match(/(?:id=|\/d\/)([-\w]{10,})/);
    return match ? `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000` : link;
  });
}

function formatStars(n){
  const c = Math.max(0,Math.min(5,parseInt(n)||0));
  return "‚òÖ".repeat(c) + "‚òÜ".repeat(5-c);
}

function parseDateForSort(s) {
  if (!s) return 0;
  s = String(s).trim();

  // 1) Handle Google Sheets "Date(YYYY,MM,DD,HH,MM,SS)"
  let m = s.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
  if (m) {
    let [_, y, mo, d, h, mi, se] = m.map(Number);
    return new Date(y, mo, d, h, mi, se).getTime();
  }

  // 2) Try regular JS Date
  let d = new Date(s);
  if (!isNaN(d)) return d.getTime();

  // 3) Try Chinese AM/PM format
  const zh = /(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})\s*(‰∏äÂçà|‰∏ãÂçà)?\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/;
  const z = s.match(zh);
  if (z) {
    let [_, y, mo, da, ampm, h, mi, se] = z;
    mo = +mo - 1;
    h = +h;
    mi = +mi;
    se = +se || 0;
    if (ampm === "‰∏ãÂçà" && h < 12) h += 12;
    if (ampm === "‰∏äÂçà" && h === 12) h = 0;
    return new Date(+y, mo, +da, h, mi, se).getTime();
  }

  return 0;
}


function buildCardHTML(item){
  const p=item["Product"]||"Unnamed";
  const imgs=parseImagesField(item["picture"]||item["Picture"]);
  const time=item["timestamp"]||item["ÊôÇÈñìÊà≥Ë®ò"];
  const loc = item["Location"] || "-";
  const shop = item["Shop"] || "-";
  
  const need = item["ÂøÖË≤∑"] || item["Need"] || "";
  const num = (item["‰ª∂Êï∏"] ?? item["Number"] ?? "").toString(); //this change
  
  const notes = item["Notes"] || "";
  const price = item["Price"] || item["ÂèÉËÄÉÂÉπÈå¢(Ê∏ØÂÖÉ/Êó•ÂÖÉ)"] || "";

  let html=`<article class="card" data-ts="${parseDateForSort(time)}">`;
  html+=`<div class="media">`;
  if(imgs.length) imgs.forEach((u,i)=>html+=`<img src="${u}" style="display:${i===0?'block':'none'};">`);
  else html+=`<div class="placeholder">No image</div>`;
  html+=`</div>`;
  if(imgs.length>1) html+=`
  <div class="carousel-outside">
    <button class="prev">‚óÄ</button>
    <span class="count">1 / ${imgs.length}</span>
    <button class="next">‚ñ∂</button>
  </div>`;
  html+=`<div class="card-body">
      <p class="product-title">${escapeHtml(p)}</p>
      <div class="meta-row">
        <div class="meta-item">Price: ${escapeHtml(price||"-")}</div>
        <div class="meta-item">Number: ${escapeHtml(num||"-")}</div>
      </div>
      <div class="meta-row">
        <div class="meta-item">Location: ${escapeHtml(loc)}</div>
        <div class="meta-item">Shop: ${escapeHtml(shop)}</div>
      </div>
      <div class="meta-row"><div class="meta-item">Need: <span class="stars">${formatStars(need)}</span></div></div>
      ${notes?`<div class="notes">${escapeHtml(notes)}</div>`:""}
    </div>`;
  html+=`
  <div class="footer">
    <div class="timestamp">${time||""}</div>
    <button class="boughtBtn">‚úÖ Bought</button>
  </div>
  </article>`;

  return html;
}

async function fetchAndRender(){
  const out=document.getElementById("output");
  out.textContent="Loading...";
  try{
    const r=await fetch(SHEET_URL);
    const txt=await r.text();
    const json=JSON.parse(txt.substring(txt.indexOf("{"),txt.lastIndexOf("}")+1));
    const cols=json.table.cols.map(c=>c.label);
    RAW_ROWS = json.table.rows.map(r => {
      const o = {};
      (r.c || []).forEach((c, i) => {
        o[cols[i]] = c ? (c.f ?? c.v ?? "") : "";
      });
      return o;
    });

    
    populateFilters(RAW_ROWS);
    renderCards(RAW_ROWS);
  }catch(e){
    out.innerHTML=`<p style="color:red">Load failed</p>`;
    console.error(e);
  }
}

function populateFilters(rows) {
  const locSet = new Set();
  const shopSet = new Set();
  const splitRE = /[,\.;\/\|\u3001]/;

  rows.forEach(r => {
    const locRaw = r["Location"] || r["‰ΩçÁΩÆ"] || "";
    const shopRaw = r["Shop"] || r["ÂïÜÂ∫ó"] || "";

    locRaw.split(splitRE).map(s => s.trim()).forEach(t => { if (t) locSet.add(t); });
    shopRaw.split(splitRE).map(s => s.trim()).forEach(t => { if (t) shopSet.add(t); });
  });

  const locSel = document.getElementById("filterLocation");
  const shopSel = document.getElementById("filterShop");

  if (locSel) {
    locSel.innerHTML = '<option value="">All</option>' +
      Array.from(locSet).sort((a,b)=>a.localeCompare(b)).map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
  }

  if (shopSel) {
    shopSel.innerHTML = '<option value="">All</option>' +
      Array.from(shopSet).sort((a,b)=>a.localeCompare(b)).map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
  }
}

function renderCards(rows){
  const out=document.getElementById("output");
  const search=(document.getElementById("searchInput").value||"").toLowerCase();
  const loc=document.getElementById("filterLocation").value||"";
  const shop=document.getElementById("filterShop").value||"";
  const order=document.getElementById("sortSelect").value;

  const splitRE = /[,\.;\/\|\u3001]/;
  

  let f = rows.filter(r => {
    const product = (r["Product"] || "").toLowerCase();
    const locTokens = (r["Location"] || "").split(splitRE).map(s => s.trim().toLowerCase()).filter(Boolean);
    const shopTokens = (r["Shop"] || "").split(splitRE).map(s => s.trim().toLowerCase()).filter(Boolean);
  
    const locMatch = !loc || locTokens.some(t => t.includes(loc.toLowerCase()));
    const shopMatch = !shop || shopTokens.some(t => t.includes(shop.toLowerCase()));
    const searchMatch = !search || product.includes(search);
  
    return locMatch && shopMatch && searchMatch;
  });
  const hideBought = document.getElementById("hideBoughtCheckbox")?.checked;
  const bought = JSON.parse(localStorage.getItem("boughtItems") || "{}");
  
  if (hideBought) {
    f = f.filter(r => !bought[(r["Product"] || "").trim().toLowerCase()]);
  }


  f.sort((a,b)=>{
    const ta=parseDateForSort(a["timestamp"]||a["ÊôÇÈñìÊà≥Ë®ò"]);
    const tb=parseDateForSort(b["timestamp"]||b["ÊôÇÈñìÊà≥Ë®ò"]);
    const na=parseInt(a["ÂøÖË≤∑"]||a["Need"])||0;
    const nb=parseInt(b["ÂøÖË≤∑"]||b["Need"])||0;
    switch(order){
      case "old": return ta-tb;
      case "needHigh": return nb-na;
      case "needLow": return na-nb;
      default: return tb-ta;
    }
  });

  out.innerHTML = f.length?`<div class="card-grid">${f.map(buildCardHTML).join("")}</div>`:"<p>No items</p>";

  document.querySelectorAll(".card").forEach(card=>{
    const imgs=card.querySelectorAll(".media img");
    const prev=card.querySelector(".prev");
    const next=card.querySelector(".next");
    const count=card.querySelector(".count");
    if(!imgs.length) return;
    let cur=0;
    function show(i){imgs.forEach((im,ix)=>im.style.display=ix===i?"block":"none"); if(count)count.textContent=`${i+1}/${imgs.length}`;}
    prev&&prev.addEventListener("click",()=>show(cur=(cur-1+imgs.length)%imgs.length));
    next&&next.addEventListener("click",()=>show(cur=(cur+1)%imgs.length));
    imgs.forEach(img=>img.addEventListener("click",()=>window.open(img.src,"_blank")));
  });

  //call local track
  applyBoughtState();
  setupBoughtButtons();
}

// --- Local Bought Tracking ---
function applyBoughtState() {
  const bought = JSON.parse(localStorage.getItem("boughtItems") || "{}");
  document.querySelectorAll(".card").forEach(card => {
    const title = card.querySelector(".product-title")?.textContent.trim();
    if (bought[title]) card.classList.add("bought");
  });
}

function setupBoughtButtons() {
  const bought = JSON.parse(localStorage.getItem("boughtItems") || "{}");

  document.querySelectorAll(".card").forEach(card => {
    const title = card.querySelector(".product-title")?.textContent.trim();
    const btn = card.querySelector(".boughtBtn");

    if (!btn) return;

    // Set initial text
    btn.textContent = bought[title] ? "‚Ü©Ô∏è Undo" : "‚úÖ Bought";

    btn.addEventListener("click", () => {
      if (bought[title]) {
        delete bought[title];
      } else {
        bought[title] = true;
      }
      localStorage.setItem("boughtItems", JSON.stringify(bought));
      renderCards(RAW_ROWS);
    });
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("toggleFiltersBtn");
  const panel = document.getElementById("filterPanel");

  if (btn && panel) {
    btn.addEventListener("click", () => {
      const show = panel.classList.toggle("show");
      btn.textContent = show ? "Filters ‚ñ¥" : "Filters ‚ñæ";
    });
  }

  // ‚úÖ Hide Bought checkbox listener (placed correctly here)
  const hideBox = document.getElementById("hideBoughtCheckbox");
  if (hideBox) {
    hideBox.addEventListener("change", () => {
      renderCards(RAW_ROWS);
    });
  }

  ["filterLocation","filterShop","sortSelect"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("change", () => renderCards(RAW_ROWS));
  });

  const search = document.getElementById("searchInput");
  if (search) search.addEventListener("input", ()=>renderCards(RAW_ROWS));

  const refresh = document.getElementById("refreshBtn");
  if (refresh) refresh.addEventListener("click", () => fetchAndRender());

  fetchAndRender();
  setRefreshInterval(REFRESH_INTERVAL_MS);
});

function setRefreshInterval(ms){
  if(refreshTimer) clearInterval(refreshTimer);
  if(ms>0) refreshTimer=setInterval(fetchAndRender,ms);
  REFRESH_INTERVAL_MS=ms;
}
</script>
</body>
</html>
