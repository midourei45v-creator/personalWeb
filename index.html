<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Live Product Requests</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --muted:#666; --accent:#2366d6;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); margin:20px;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  h1{font-size:1.1rem;margin:0}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  select, button{padding:6px 10px;border-radius:6px;border:1px solid #d0d7e6;background:#fff}
  #output{min-height:80vh}
  .card-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:18px;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    box-shadow:0 4px 18px rgba(20,30,60,0.06);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .media{
    width:100%;
    height:170px;
    background:#eee;
    position:relative;
  }
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .carousel-controls{
    position:absolute;left:8px;right:8px;bottom:8px;display:flex;justify-content:space-between;gap:8px;
  }
  .carousel-controls button{background:rgba(0,0,0,0.4);color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
  .card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
  .product-title{font-weight:600;margin:0;font-size:1rem}
  .meta-row{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:0.9rem}
  .meta-item{background:#f3f6fb;padding:6px 8px;border-radius:8px}
  .inline{display:inline-flex;align-items:center;gap:8px}
  .stars{color:#f2b01e}
  .notes{font-size:0.9rem;color:#222}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-top:1px solid #f0f2f6;background:#fafbfe;font-size:0.85rem}
  .timestamp{color:var(--muted)}
  .placeholder{display:flex;align-items:center;justify-content:center;height:100%;color:#777;font-size:0.95rem}
  @media (max-width:420px){ .media{height:150px} }
</style>
</head>
<body>

<header>
  <h1>ðŸ“¦Buy List</h1>

  <div class="controls">
    <input type="search" id="searchInput" placeholder="Search product..." style="padding:6px 10px;border-radius:6px;border:1px solid #d0d7e6;width:160px">
    
    <label>
      Sort:
      <select id="sortSelect" title="Sort by timestamp">
        <option value="new">Newest first</option>
        <option value="old">Oldest first</option>
      </select>
    </label>
    <label>
      Location:
      <select id="filterLocation">
        <option value="">All</option>
      </select>
    </label>
    
    <label>
      Shop:
      <select id="filterShop">
        <option value="">All</option>
      </select>
    </label>


    <button id="refreshBtn">Refresh</button>
  </div>
</header>

<main>
  <div id="output">Loading...</div>
</main>

<script>
const SHEET_ID = "1XuPRye8Rdk35hajUUqG3Ig5jFl4FmD_sDqECFK_ENBQ"; // <-- replace me
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const REFRESH_INTERVAL_MS = 60000; // auto-refresh every 60s (change or set to 0 to disable)

let RAW_ROWS = []; // internal data store (array of objects)

function parseImagesField(fieldValue) {
  if (!fieldValue) return [];

  // Split on space, comma, or semicolon
  const parts = fieldValue
    .split(/\s+|,|;/)
    .map(s => s.trim())
    .filter(Boolean);

  const images = parts.map(p => {
    // --- Normalize Google Drive links ---
    // Handles /open?id=XXXX
    const openMatch = p.match(/open\?id=([a-zA-Z0-9_-]{10,})/);
    // Handles /file/d/XXXX/
    const driveMatch = p.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
    // Handles ?id=XXXX
    const idMatch = p.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);

    const id = openMatch?.[1] || driveMatch?.[1] || idMatch?.[1];
    if (id) {
      return `https://drive.google.com/uc?export=view&id=${id}`;
    }

    // Handle direct googleusercontent links
    if (p.includes("googleusercontent.com")) return p;

    // Handle direct image links (.jpg/.png etc.)
    if (/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(p)) return p;

    return null; // Unknown pattern
  }).filter(Boolean);

  return images;
}

function formatStars(n){
  const count = Math.max(0, Math.min(5, parseInt(n) || 0));
  return "â˜…".repeat(count) + "â˜†".repeat(Math.max(0,5-count));
}

function buildCardHTML(item, idx){
  // item: object with keys matching sheet headers
  const product = item["Product"] || "Unnamed Product";
  const requestBy = item["Your_name"] || item["Your Name"] || item["Request_by"] || "-";
  const location = item["Location"] || "-";
  const shop = item["Shop"] || "-";
  const number = item["Number"] || "-";
  const need = item["Need"] || ""; // numeric rating
  const notes = item["Notes"] || "";
  const price = item["price"] || "";
  const tsRaw = item["timestamp"] || item["TimeStamp"] || item["Timestamp"] || item["Time"] || "";
  const images = parseImagesField(item["picture"] || item["picture "] || item["Picture"] || "");

  // header of card
  let html = `<article class="card" data-ts="${tsRaw ? (new Date(tsRaw)).getTime() : 0}" id="card-${idx}">`;

  // media area + carousel
  html += `<div class="media">`;
  if (images.length === 0){
    html += `<div class="placeholder">No image</div>`;
  } else {
    // show first image and attach data for carousel via data-images attribute
    html += `<img src="${images[0]}" alt="${escapeHtml(product)}" data-images='${JSON.stringify(images)}'/>`;
    if (images.length > 1) {
      html += `<div class="carousel-controls">
        <button class="prev" aria-label="Prev image">â—€</button>
        <button class="next" aria-label="Next image">â–¶</button>
      </div>`;
    }
  }
  html += `</div>`; // end media

  // body
  html += `<div class="card-body">`;
  html += `<div style="display:flex;justify-content:space-between;align-items:start;gap:8px">
             <div style="flex:1">
               <p class="product-title">${escapeHtml(product)}</p>
               <div class="meta-row">
                 <div class="meta-item">Request by: <strong>${escapeHtml(requestBy)}</strong></div>
                 <div class="meta-item">Price: ${escapeHtml(price||"-")}</div>
               </div>
             </div>
           </div>`;

  html += `<div class="meta-row" style="margin-top:6px">
             <div class="meta-item">Location: ${escapeHtml(location)}</div>
             <div class="meta-item">Shop: ${escapeHtml(shop)}</div>
           </div>`;

  html += `<div class="meta-row" style="margin-top:6px">
             <div class="meta-item">Number: ${escapeHtml(number)}</div>
             <div class="meta-item">Need: <span class="stars">${escapeHtml(formatStars(need))}</span></div>
           </div>`;

  if (notes) html += `<div class="notes">${escapeHtml(notes)}</div>`;

  html += `</div>`; // end card-body

  // footer with hidden timestamp (but accessible for sorting)
  html += `<div class="footer">
             <div class="timestamp">${isNaN(new Date(tsRaw)) ? "" : new Date(tsRaw).toLocaleString()}</div>
           </div>`;

  html += `</article>`;
  return html;
}
  
function populateFilters(rows) {
  const locSet = new Set();
  const shopSet = new Set();

  rows.forEach(r => {
    if (r["Location"]) r["Location"].split(/,|;/).forEach(v => locSet.add(v.trim()));
    if (r["Shop"]) r["Shop"].split(/,|;/).forEach(v => shopSet.add(v.trim()));
  });

  const locSelect = document.getElementById("filterLocation");
  const shopSelect = document.getElementById("filterShop");

  // Fill Location filter
  if (locSelect) {
    locSelect.innerHTML = '<option value="">All</option>' +
      Array.from(locSet).sort().map(v => `<option>${v}</option>`).join("");
  }

  // Fill Shop filter
  if (shopSelect) {
    shopSelect.innerHTML = '<option value="">All</option>' +
      Array.from(shopSet).sort().map(v => `<option>${v}</option>`).join("");
  }
}

function escapeHtml(str){
  if(!str && str !== 0) return "";
  return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
}
function parseGoogleGviz(txt) {
  // Remove leading JS callback wrapper used by Google's gviz output
  const jsonStr = txt
    .substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1);
  try {
    return JSON.parse(jsonStr);
  } catch (e) {
    console.error("Failed to parse GViz JSON", e);
    return { table: { cols: [], rows: [] } };
  }
}

async function fetchAndRender(){
  const out = document.getElementById("output");
  out.innerHTML = "Loading...";
  try {
    const r = await fetch(SHEET_URL);
    const txt = await r.text();
    const json = parseGoogleGviz(txt);
    const cols = json.table.cols.map(c => c.label || "");
    const rows = json.table.rows.map(row => {
      const obj = {};
      (row.c || []).forEach((cell,i) => obj[cols[i]||`col${i}`] = cell ? cell.v : "");
      return obj;
    });

    RAW_ROWS = rows; // store raw
    console.log("Parsed image URLs:", rows.map(r => parseImagesField(r["picture"])).flat());
    renderCards(rows);
    populateFilters(rows);
  } catch(err){
    console.error(err);
    out.innerHTML = `<p style="color:red">Failed to load sheet. Open console for details.</p>`;
  }
}

function renderCards(rows){
  const out = document.getElementById("output");
  const sortSel = document.getElementById("sortSelect");
  const order = sortSel?.value || "new";
  const locSel = document.getElementById("filterLocation")?.value || "";
  const shopSel = document.getElementById("filterShop")?.value || "";

  // Step 1: filter
  const searchValue = document.getElementById("searchInput")?.value.trim().toLowerCase() || "";

  let filtered = rows.filter(r => {
    const loc = (r["Location"] || "").toLowerCase();
    const shop = (r["Shop"] || "").toLowerCase();
    const product = (r["Product"] || "").toLowerCase();

    const locMatch = !locSel || loc.includes(locSel.toLowerCase());
    const shopMatch = !shopSel || shop.includes(shopSel.toLowerCase());
    const searchMatch = !searchValue || product.includes(searchValue);

    return locMatch && shopMatch && searchMatch;
  });


  // Step 2: sort the filtered array
  filtered.sort((a, b) => {
    const ta = parseDateForSort(a["timestamp"] || a["TimeStamp"] || a["Timestamp"]);
    const tb = parseDateForSort(b["timestamp"] || b["TimeStamp"] || b["Timestamp"]);
    return order === "new" ? tb - ta : ta - tb;
  });

  // Step 3: render
  if (filtered.length === 0) {
    out.innerHTML = "<p>No matching requests found.</p>";
    return;
  }

  let html = `<div class="card-grid">`;
  filtered.forEach((r, i) => html += buildCardHTML(r, i));
  html += `</div>`;
  out.innerHTML = html;

  // Step 4: attach carousel button handlers
  document.querySelectorAll(".card .prev, .card .next").forEach(btn => {
    btn.addEventListener("click", ev => {
      const card = ev.target.closest(".card");
      const img = card.querySelector(".media img");
      if (!img) return;
      let images = JSON.parse(img.getAttribute("data-images") || "[]");
      if (images.length < 2) return;
      let idx = images.indexOf(img.src);
      if (idx === -1) idx = 0;
      if (ev.target.classList.contains("prev")) {
        idx = (idx - 1 + images.length) % images.length;
      } else {
        idx = (idx + 1) % images.length;
      }
      img.src = images[idx];
    });
  });
}

function parseDateForSort(s) {
  if (!s) return 0;
  // Try native Date()
  let d = new Date(s);
  if (!isNaN(d)) return d.getTime();

  // Try known patterns (Google Form style "2025/10/20 17:43:00")
  const match = s.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})[^\d]+(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (match) {
    const [, y, m, d_, hh, mm, ss] = match.map(Number);
    return new Date(y, m - 1, d_, hh, mm, ss || 0).getTime();
  }
  return 0;
}


document.getElementById("sortSelect")?.addEventListener("change", ()=> renderCards(RAW_ROWS));
document.getElementById("refreshBtn")?.addEventListener("click", ()=> fetchAndRender());
["filterLocation", "filterShop"].forEach(id => {
  document.getElementById(id)?.addEventListener("change", () => renderCards(RAW_ROWS));
});
document.getElementById("searchInput")?.addEventListener("input", () => renderCards(RAW_ROWS));


// initial load
fetchAndRender();

// auto refresh if requested
if (REFRESH_INTERVAL_MS > 0) setInterval(fetchAndRender, REFRESH_INTERVAL_MS);
</script>

</body>
</html>
