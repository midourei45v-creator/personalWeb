<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Live Product Requests</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --muted:#666; --accent:#2366d6;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); margin:20px;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  h1{font-size:1.1rem;margin:0}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  select, button{padding:6px 10px;border-radius:6px;border:1px solid #d0d7e6;background:#fff}
  #output{min-height:80vh}
  .card-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:18px;
  }
  .card{
    background:var(--card);
    border-radius:12px;
    box-shadow:0 4px 18px rgba(20,30,60,0.06);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .media{
    width:100%;
    height:170px;
    background:#eee;
    position:relative;
  }
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .carousel-controls{
    position:absolute;left:8px;right:8px;bottom:8px;display:flex;justify-content:space-between;gap:8px;
  }
  .carousel-controls button{background:rgba(0,0,0,0.4);color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
  .card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
  .product-title{font-weight:600;margin:0;font-size:1rem}
  .meta-row{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:0.9rem}
  .meta-item{background:#f3f6fb;padding:6px 8px;border-radius:8px}
  .inline{display:inline-flex;align-items:center;gap:8px}
  .stars{color:#f2b01e}
  .notes{font-size:0.9rem;color:#222}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-top:1px solid #f0f2f6;background:#fafbfe;font-size:0.85rem}
  .timestamp{color:var(--muted)}
  .placeholder{display:flex;align-items:center;justify-content:center;height:100%;color:#777;font-size:0.95rem}
  @media (max-width:420px){ .media{height:150px} }
</style>
</head>
<body>

<header>
  <h1>ðŸ“¦ Product Requests</h1>

  <div class="controls">
    <label>
      Sort:
      <select id="sortSelect" title="Sort by timestamp">
        <option value="new">Newest first</option>
        <option value="old">Oldest first</option>
      </select>
    </label>

    <button id="refreshBtn">Refresh</button>
  </div>
</header>

<main>
  <div id="output">Loading...</div>
</main>

<script>
const SHEET_ID = "1XuPRye8Rdk35hajUUqG3Ig5jFl4FmD_sDqECFK_ENBQ"; // <-- replace me
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const REFRESH_INTERVAL_MS = 60000; // auto-refresh every 60s (change or set to 0 to disable)

let RAW_ROWS = []; // internal data store (array of objects)

function parseGoogleGviz(text){
  // Google returns: google.visualization.Query.setResponse(...);
  const json = JSON.parse(text.substr(47).slice(0, -2));
  return json;
}

function parseImagesField(fieldValue){
  if(!fieldValue) return [];
  // split by whitespace or comma or semicolon
  const parts = fieldValue.split(/\s+|,|;/).map(s => s.trim()).filter(Boolean);
  // Keep only likely URLs or Drive file IDs; convert Drive links to direct view link
  const images = parts.map(p => {
    // If looks like a Google Drive link, convert
    // patterns: https://drive.google.com/file/d/FILEID/view?usp=..., https://drive.google.com/open?id=FILEID, or plain FILEID
    const driveMatch = p.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
    const idMatch = p.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
    if (driveMatch) return `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;
    if (idMatch) return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
    // if plain URL:
    if (/^https?:\/\//i.test(p)) return p;
    // if looks like a raw drive file id (length 20+ chars), attempt convert
    if (/^[a-zA-Z0-9_-]{20,}$/.test(p)) return `https://drive.google.com/uc?export=view&id=${p}`;
    // otherwise it's probably a filename â€” skip it
    return null;
  }).filter(Boolean);
  return images;
}

function formatStars(n){
  const count = Math.max(0, Math.min(5, parseInt(n) || 0));
  return "â˜…".repeat(count) + "â˜†".repeat(Math.max(0,5-count));
}

function buildCardHTML(item, idx){
  // item: object with keys matching sheet headers
  const product = item["Product"] || "Unnamed Product";
  const requestBy = item["Your_name"] || item["Your Name"] || item["Request_by"] || "-";
  const location = item["Location"] || "-";
  const shop = item["Shop"] || "-";
  const number = item["Number"] || "-";
  const need = item["Need"] || ""; // numeric rating
  const notes = item["Notes"] || "";
  const price = item["price"] || "";
  const tsRaw = item["TimeStamp"] || item["Timestamp"] || item["Time"] || "";
  const images = parseImagesField(item["picture"] || item["picture "] || item["Picture"] || "");

  // header of card
  let html = `<article class="card" data-ts="${tsRaw ? (new Date(tsRaw)).getTime() : 0}" id="card-${idx}">`;

  // media area + carousel
  html += `<div class="media">`;
  if (images.length === 0){
    html += `<div class="placeholder">No image</div>`;
  } else {
    // show first image and attach data for carousel via data-images attribute
    html += `<img src="${images[0]}" alt="${escapeHtml(product)}" data-images='${JSON.stringify(images)}'/>`;
    if (images.length > 1) {
      html += `<div class="carousel-controls">
        <button class="prev" aria-label="Prev image">â—€</button>
        <button class="next" aria-label="Next image">â–¶</button>
      </div>`;
    }
  }
  html += `</div>`; // end media

  // body
  html += `<div class="card-body">`;
  html += `<div style="display:flex;justify-content:space-between;align-items:start;gap:8px">
             <div style="flex:1">
               <p class="product-title">${escapeHtml(product)}</p>
               <div class="meta-row">
                 <div class="meta-item">Request by: <strong>${escapeHtml(requestBy)}</strong></div>
                 <div class="meta-item">Price: ${escapeHtml(price||"-")}</div>
               </div>
             </div>
           </div>`;

  html += `<div class="meta-row" style="margin-top:6px">
             <div class="meta-item">Location: ${escapeHtml(location)}</div>
             <div class="meta-item">Shop: ${escapeHtml(shop)}</div>
           </div>`;

  html += `<div class="meta-row" style="margin-top:6px">
             <div class="meta-item">Number: ${escapeHtml(number)}</div>
             <div class="meta-item">Need: <span class="stars">${escapeHtml(formatStars(need))}</span></div>
           </div>`;

  if (notes) html += `<div class="notes">${escapeHtml(notes)}</div>`;

  html += `</div>`; // end card-body

  // footer with hidden timestamp (but accessible for sorting)
  html += `<div class="footer">
             <div class="timestamp">${tsRaw ? new Date(tsRaw).toLocaleString() : ""}</div>
             <div style="font-size:0.85rem;color:var(--muted)">ID:${idx+1}</div>
           </div>`;

  html += `</article>`;
  return html;
}

function escapeHtml(str){
  if(!str && str !== 0) return "";
  return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
}

async function fetchAndRender(){
  const out = document.getElementById("output");
  out.innerHTML = "Loading...";
  try {
    const r = await fetch(SHEET_URL);
    const txt = await r.text();
    const json = parseGoogleGviz(txt);
    const cols = json.table.cols.map(c => c.label || "");
    const rows = json.table.rows.map(row => {
      const obj = {};
      (row.c || []).forEach((cell,i) => obj[cols[i]||`col${i}`] = cell ? cell.v : "");
      return obj;
    });

    RAW_ROWS = rows; // store raw
    renderCards(rows);
  } catch(err){
    console.error(err);
    out.innerHTML = `<p style="color:red">Failed to load sheet. Open console for details.</p>`;
  }
}

function renderCards(rows){
  const out = document.getElementById("output");
  // sort according to select
  const sortSel = document.getElementById("sortSelect");
  const order = sortSel?.value || "new";
  rows.sort((a,b)=>{
    const ta = parseDateForSort(a["TimeStamp"] || a["Timestamp"]);
    const tb = parseDateForSort(b["TimeStamp"] || b["Timestamp"]);
    return order === "new" ? tb - ta : ta - tb;
  });

  if(rows.length === 0){
    out.innerHTML = "<p>No requests found.</p>";
    return;
  }

  let html = `<div class="card-grid">`;
  rows.forEach((r,i)=> html += buildCardHTML(r,i));
  html += `</div>`;
  out.innerHTML = html;

  // attach carousel handlers
  document.querySelectorAll(".card .prev, .card .next").forEach(btn=>{
    btn.addEventListener("click", ev=>{
      const card = ev.target.closest(".card");
      const img = card.querySelector(".media img");
      if(!img) return;
      let images = JSON.parse(img.getAttribute("data-images") || "[]");
      if(images.length < 2) return;
      // find index:
      let idx = images.indexOf(img.src);
      if(idx === -1) idx = 0;
      if(ev.target.classList.contains("prev")){
        idx = (idx - 1 + images.length) % images.length;
      } else {
        idx = (idx + 1) % images.length;
      }
      img.src = images[idx];
    });
  });
}

function parseDateForSort(s){
  if(!s) return 0;
  const d = new Date(s);
  if(!isNaN(d.getTime())) return d.getTime();
  // attempt parse common formats if needed
  const alt = Date.parse(s);
  return isNaN(alt) ? 0 : alt;
}

document.getElementById("sortSelect")?.addEventListener("change", ()=> renderCards(RAW_ROWS));
document.getElementById("refreshBtn")?.addEventListener("click", ()=> fetchAndRender());

// initial load
fetchAndRender();

// auto refresh if requested
if (REFRESH_INTERVAL_MS > 0) setInterval(fetchAndRender, REFRESH_INTERVAL_MS);
</script>

</body>
</html>
